<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="phaser.js"></script>
    <title>Space Invaders</title>
  </head>
  <body>
    <script type="text/javascript">
      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
          default: "arcade",
          arcade: {
            gravity: { y: 300 },
            debug: false,
          },
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };

      var sky;
      var ship;
      var bullets;
      var leftKey;
      var rightKey;
      var fire;

      var game = new Phaser.Game(config);

      function preload() {
        this.load.image("sky", "./assets/sky.jpeg");
        this.load.image("ship", "./assets/spaceship.png");
        this.load.image("laser-bullet", "./assets/laser-bullet.png");
      }

      function create() {
        var Bullet = new Phaser.Class({
          Extends: Phaser.Physics.Arcade.Image,

          initialize: function Bullet(scene) {
            Phaser.Physics.Arcade.Image.call(this, scene, 0, 0, "laser-bullet");

            this.setBlendMode(1);
            this.setDepth(1);

            this.speed = 1000;
            this.lifespan = 1000;

            this._temp = new Phaser.Math.Vector2();
          },

          fire: function (ship) {
            this.lifespan = 1000;

            this.setActive(true);
            this.setVisible(true);
            this.setPosition(ship.x, ship.y);
            this.body.reset(ship.x, ship.y);

            this.body.velocity.x *= 2;
            this.body.velocity.y *= 2;
          },
        });

        sky = this.add.image(700, 350, "sky");
        ship = this.add.image(400, 600, "ship").setOrigin(0.5, 1);
        ship.setScale(0.2);

        // Bullets
        bullets = this.physics.add.group({
          classType: Bullet,
          maxSize: 30,
          runChildUpdate: true,
        });

        // Controls config
        leftKey = this.input.keyboard.addKey(
          Phaser.Input.Keyboard.KeyCodes.LEFT
        );
        rightKey = this.input.keyboard.addKey(
          Phaser.Input.Keyboard.KeyCodes.RIGHT
        );
        fire = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
      }

      function update(time, delta) {
        if (leftKey.isDown && ship.x > 0 + ship.displayWidth * ship.originX) {
          ship.x -= 5;
        } else if (
          rightKey.isDown &&
          ship.x < this.sys.canvas.width - ship.displayWidth * ship.originX
        ) {
          ship.x += 5;
        }

        if (fire.isDown) {
          var bullet = bullets.get();

          if (bullet) {
            bullet.fire(ship);
          }
        }
      }
    </script>
  </body>
</html>
